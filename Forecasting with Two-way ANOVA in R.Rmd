---
title: "Forecasting with Two-Way ANOVA in R"
author: "Anita Owens"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
      
---


# 1. Set up environment

```{r Load packages}
# Install pacman if needed
if (!require("pacman")) install.packages("pacman")

# load packages
pacman::p_load(pacman,
  tidyverse, openxlsx, ggpubr)
```



## Scenario: If there is interaction between the groups


```{r Import games dataset}
games <- read.xlsx("datasets/games.xlsx", sheet = 3)
```


```{r Check structure}
games
```

```{r Make dataset long}
(games_long <- games %>% 
  pivot_longer(cols = starts_with("Price"), #columns to pivot to rows
               names_to = "price", #name the new column for the price variable
               values_to = "sales")) #the new sales column
```

```{r Re-level categorical variables}
games_long <- games_long %>% 
  mutate(advertising = factor(Advertising, levels = c("Low", "Medium", "High")),
  price = factor(price, levels = c("PriceLow", "PriceMedium", "PriceHigh"))) %>% 
  select(-Advertising)

str(games_long)
```

```{r Normality function}

normality_function <- function(y, x, stat_test){
  result <- tapply(y, x, stat_test)
  for(i in 1:length(result)){
    if(result[[i]][[2]] < 0.05){
      print("Not normal distribution")
    } else{
      print("Distributions are normal")
    }
  }
}

# normality_function <- function(y, x, stat_test){
#   result <- tapply(y, x, stat_test)
#   for(i in 1:length(result)){
#     if(result[[i]][[2]] < 0.05){
#       print(paste("Not normal distribution", names(result), sep = " "))
#     } else{
#       print("Distributions are normal")
#     }
#   }
# }

normality_function(games_long$sales, games_long$advertising, shapiro.test)

#normality_function(games_long$sales, games_long$price, shapiro.test)
```


```{r Check for normality in games dataset}
# Test normality across groups (Shapiro)
tapply(games_long$sales, games_long$advertising, FUN = shapiro.test)

tapply(games_long$sales, games_long$price, FUN = shapiro.test)
```

```{r Check homogeneity of variance in games dataset}
# Check the homogeneity of variance (Bartlett)
bartlett.test(sales ~ advertising, data = games_long)
bartlett.test(sales ~ price, data = games_long)
```


```{r Visualize sales by advertising spend and price}
#Plot using ggpubr
ggline(games_long, x = "advertising", y = "sales", 
       add = c("mean_se", "jitter"),
       color = "price", palette = "jco",
       title = "Sales increase when ad spending increases",
       subtitle = "(but not when prices are high)",
       legend.title = "price levels"
       )
```



The aov function models each combination of advertising and price on sales.

The f-values and p-values suggests that we reject the null hypothesis for advertising, price, and the interaction between advertising and price.

```{r Two-way ANOVA model}
two_way_aov <- aov(sales ~ advertising*price, data = games_long)

#The anova table
summary(two_way_aov)
```


```{r}
lm_model <- lm(sales ~  advertising*price, data = games_long)
summary(lm_model)
```


How do we use this information to forecast?

Since the p-value for the interaction (advertising*price) is very small, we can forecast sales for any price and advertising combination equal to the mean of the observations.

```{r Forecast}
games_long %>% 
  group_by(advertising, price) %>% 
  summarize(forecast_sales = round(mean(sales),2),
            stand_dev = round(sd(sales),2))
```

```{r Accuracy}

```



A key insight for marketing stakeholders, would be to cut back on advertising when the price is high.

If there is seasonality, you can incorporate seasonality and proceed with two-way ANOVA for forecasting.

If there is no significant interaction between your two independent variables you can forecast using the following equation:

predicted_sales = overall_average + row_effect(if significant) +
column_effect(if significant)
